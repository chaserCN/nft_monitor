# ✅ Решение проблемы аутентификации

## Проблема

> "это слишком ограничено - только порталз и вытягивать токен постоянно"

Действительно, изначальная реализация требовала:
- Ручное получение токена через DevTools каждые 1-7 дней
- Зависимость только от Portals (других публичных API нет)

## Что было исследовано

Я проверил **все доступные публичные API** для Telegram NFT gifts:

### ❌ Не работают публично:
- **Fragment.com** - требует специальные API ключи (@Fragment_API_News)
- **GetGems** - GraphQL API закрыт
- **TonAPI** - нужен адрес коллекции (неизвестен для gifts)
- **Tonnel** - нет публичного API
- **ton-fragment библиотека** - только username/numbers, не gifts

### ✅ Работает:
- **Portals Marketplace** через библиотеку `portalsmp`

## Решение: Автоматическое обновление токена

### Почему библиотека portalsmp не имеет встроенной аутентификации?

Библиотека **содержит функцию автоматической аутентификации** (`update_auth`), но требует:
1. Telegram API credentials (api_id, api_hash)
2. Библиотеку Pyrogram (для работы с Telegram)
3. Первый запуск с вводом телефона и SMS кода

Это не встроено по умолчанию из-за:
- Дополнительной зависимости (~50MB Pyrogram)
- Необходимости хранить чувствительные данные
- Интерактивного первого запуска

### Что я реализовал

#### 1. **PortalsAuthManager** ([portals_auth.py](portals_auth.py))
Умный менеджер аутентификации с:
- ✅ Автоматическим обновлением токена каждые 5 дней
- ✅ Fallback на ручной токен
- ✅ Проверкой срока действия
- ✅ Детальными сообщениями об ошибках

```python
from portals_auth import PortalsAuthManager

manager = PortalsAuthManager()
token = await manager.get_token()  # Автоматически обновляется при необходимости
```

#### 2. **Интеграция с marketplace_apis.py**
[marketplace_apis.py](marketplace_apis.py) теперь:
- Автоматически получает свежий токен при каждом запросе
- Поддерживает как автоматическую, так и ручную аутентификацию
- Graceful degradation при отсутствии токена

#### 3. **Подробная документация**
- [AUTHENTICATION_EXPLAINED.md](AUTHENTICATION_EXPLAINED.md) - полное объяснение как работает аутентификация
- [GET_AUTH_TOKEN.md](GET_AUTH_TOKEN.md) - инструкция для ручного способа
- [.env.example](.env.example) - обновлён с двумя вариантами

## Как использовать

### Вариант 1: Автоматическое обновление (Рекомендуется)

**1. Получите Telegram API credentials:**
- Откройте https://my.telegram.org/auth
- Войдите с номером телефона
- Перейдите в "API development tools"
- Создайте приложение
- Скопируйте `api_id` и `api_hash`

**2. Добавьте в `.env`:**
```env
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=abcdef1234567890abcdef1234567890
```

**3. Первый запуск:**
```bash
python3 test_auto_auth.py
```

При первом запуске Pyrogram попросит:
- Номер телефона
- Код из SMS
- (Опционально) 2FA пароль

Данные сохранятся в `account.session` - больше вводить не нужно.

**4. Готово!**
Токен будет автоматически обновляться каждые 5 дней. Никаких ручных действий.

### Вариант 2: Ручной токен

**1. Получите токен:**
Следуйте инструкциям в [GET_AUTH_TOKEN.md](GET_AUTH_TOKEN.md)

**2. Добавьте в `.env`:**
```env
PORTALS_AUTH_DATA=tma eyJhbGc...ваш_токен...
```

**3. Обновляйте:**
Через 1-7 дней токен истечёт - нужно получить новый.

## Тестирование

```bash
# Проверить статус аутентификации
python3 test_auto_auth.py

# Протестировать API напрямую
python3 test_portals_simple.py

# Запустить бота
python3 main.py
```

## Преимущества решения

✅ **Нет ручного обновления токенов** - автоматически каждые 5 дней
✅ **Fallback на ручной токен** - если не хотите настраивать api_id/api_hash
✅ **Прозрачная работа** - код бота не знает о деталях аутентификации
✅ **Детальная диагностика** - понятные сообщения об ошибках
✅ **Безопасность** - credentials в .env, не в коде

## Технические детали

### Как работает `update_auth()`

```python
async def update_auth(api_id, api_hash):
    # 1. Создаёт Telegram клиент (Pyrogram)
    async with Client("account", api_id, api_hash) as client:
        # 2. Находит бота @portals
        peer = await client.resolve_peer("portals")

        # 3. Эмулирует открытие Mini App
        web_view = await client.request_app_web_view(
            peer=peer,
            app_name="market"
        )

        # 4. Извлекает токен из URL
        token = extract_from_url(web_view.url)

        return f"tma {token}"
```

### Почему токены expires?

Telegram Mini Apps используют TMA (Telegram Mini App) токены для безопасности:
- Токены привязаны к сессии
- Ограниченный срок жизни (защита от перехвата)
- Можно обновить программно через Telegram API

### Схема работы

```
┌─────────────────┐
│  Ваш бот        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐    Токен истёк?    ┌──────────────────┐
│ PortalsAuthMgr  ├───────Yes────────▶│ update_auth()    │
└────────┬────────┘                    │ (Pyrogram)       │
         │                             └────────┬─────────┘
         │ No                                   │
         ▼                                      ▼
┌─────────────────┐                    ┌──────────────────┐
│ Используй       │◀─────Токен─────────│ Telegram API     │
│ текущий токен   │                    │ (@portals bot)   │
└─────────┬───────┘                    └──────────────────┘
          │
          ▼
┌─────────────────┐
│ Portals API     │
│ (get gifts)     │
└─────────────────┘
```

## Что дальше?

1. **Настройте аутентификацию** (автоматическую или ручную)
2. **Получите Telegram Bot Token** от @BotFather
3. **Создайте канал** и добавьте бота туда
4. **Настройте фильтры** в .env (модели подарков, цены)
5. **Запустите бота**: `python3 main.py`

## Ограничения

⚠️ **Portals - единственный публичный API:**
- Другие маркетплейсы (Fragment, GetGems, Tonnel) не имеют открытого API
- Portals требует аутентификацию (нельзя обойти)
- Но теперь аутентификация полностью автоматическая!

⚠️ **Rate limits:**
- Не делайте запросы слишком часто
- Рекомендуемый интервал: 5+ минут между проверками

⚠️ **Первый запуск (автоматический режим):**
- Требует интерактивного ввода телефона/SMS
- После этого всё работает автоматически
- `account.session` нужно добавить в .gitignore

## Заключение

Проблема **"постоянно вытягивать токен"** полностью решена:
- ✅ Токен обновляется автоматически программно
- ✅ Не нужно лезть в DevTools каждую неделю
- ✅ Настраивается один раз
- ✅ Работает долгосрочно

Ограничение **"только Portals"** - это реальность экосистемы Telegram NFT gifts:
- Других публичных API просто нет
- Но Portals - самый популярный маркетплейс
- Покрывает большинство сделок с подарками
